<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å¤„ç†ç»“æœ - æ•°å­—å›¾åƒå¤„ç†åˆ†æç³»ç»Ÿ</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: "Microsoft YaHei", sans-serif; background: #f5f7fa; color: #333; }
        
        .header { background: linear-gradient(135deg, #1a365d, #2c5282); color: white; padding: 12px 20px; display: flex; justify-content: space-between; align-items: center; position: sticky; top: 0; z-index: 100; }
        .header h1 { font-size: 16px; }
        .header-btns button { padding: 6px 12px; margin-left: 8px; border: 1px solid rgba(255,255,255,0.3); border-radius: 4px; background: transparent; color: white; cursor: pointer; font-size: 12px; }
        .header-btns button:hover { background: rgba(255,255,255,0.1); }
        
        .container { max-width: 1200px; margin: 20px auto; padding: 0 20px; }
        
        .summary { background: white; border-radius: 8px; padding: 20px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); }
        .summary h2 { color: #2c5282; font-size: 18px; margin-bottom: 10px; }
        .summary-info { display: flex; gap: 30px; color: #666; font-size: 14px; }
        
        .result-card { background: white; border-radius: 8px; margin-bottom: 20px; box-shadow: 0 2px 8px rgba(0,0,0,0.1); overflow: hidden; }
        .result-header { background: linear-gradient(135deg, #2c5282, #3182ce); color: white; padding: 12px 20px; font-size: 15px; font-weight: bold; display: flex; justify-content: space-between; align-items: center; }
        .result-header .time { font-size: 12px; opacity: 0.8; font-weight: normal; }
        .result-body { padding: 20px; }
        
        .images-row { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .image-box { text-align: center; }
        .image-box h4 { color: #2c5282; font-size: 13px; margin-bottom: 8px; }
        .image-box img { max-width: 100%; max-height: 300px; border: 1px solid #ddd; border-radius: 6px; }
        
        .metrics-row { display: grid; grid-template-columns: repeat(4, 1fr); gap: 15px; margin-bottom: 20px; }
        .metric { background: #f0fff4; border: 1px solid #c6f6d5; border-radius: 6px; padding: 12px; text-align: center; }
        .metric.warn { background: #fffbeb; border-color: #fcd34d; }
        .metric .label { font-size: 11px; color: #666; }
        .metric .value { font-size: 20px; font-weight: bold; color: #276749; margin: 5px 0; }
        .metric.warn .value { color: #b45309; }
        .metric .unit { font-size: 11px; color: #888; }
        
        .charts-section h4 { color: #2c5282; font-size: 14px; margin: 15px 0 10px 0; padding-bottom: 5px; border-bottom: 2px solid #e2e8f0; }
        .chart-box { margin-bottom: 15px; }
        .chart-box img { width: 100%; border: 1px solid #ddd; border-radius: 6px; }
        
        .stats-table { width: 100%; border-collapse: collapse; font-size: 13px; }
        .stats-table th, .stats-table td { padding: 8px 12px; border-bottom: 1px solid #e2e8f0; text-align: left; }
        .stats-table th { background: #f8fafc; color: #2c5282; }
        
        .loading { text-align: center; padding: 60px; }
        .spinner { width: 40px; height: 40px; border: 3px solid #e2e8f0; border-top-color: #3182ce; border-radius: 50%; animation: spin 1s linear infinite; margin: 0 auto 15px; }
        @keyframes spin { to { transform: rotate(360deg); } }
        
        .error { text-align: center; padding: 60px; color: #666; }
        .error .icon { font-size: 48px; margin-bottom: 15px; }
        
        .footer { text-align: center; padding: 20px; color: #999; font-size: 12px; }
        
        @media print {
            .header-btns { display: none; }
            .result-card { break-inside: avoid; }
        }
        
        @media (max-width: 768px) {
            .images-row { grid-template-columns: 1fr; }
            .metrics-row { grid-template-columns: 1fr 1fr; }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1>ğŸ“Š å¤„ç†ç»“æœæŠ¥å‘Š</h1>
        <div class="header-btns">
            <button onclick="window.print()">ğŸ–¨ï¸ æ‰“å°</button>
            <button onclick="window.close()">âœ• å…³é—­</button>
        </div>
    </div>

    <div class="container">
        <div class="loading" id="loading">
            <div class="spinner"></div>
            <p>æ­£åœ¨åŠ è½½ç»“æœ...</p>
        </div>
        
        <div class="error" id="error" style="display:none;">
            <div class="icon">ğŸ“­</div>
            <h3>ç»“æœå·²è¿‡æœŸæˆ–ä¸å­˜åœ¨</h3>
            <p>è¯·è¿”å›ä¸»é¡µé‡æ–°å¤„ç†</p>
        </div>
        
        <div id="content" style="display:none;"></div>
    </div>

    <div class="footer">æ•°å­—å›¾åƒå¤„ç†åˆ†æç³»ç»Ÿ Â· æ­¦æ±‰è½»å·¥å¤§å­¦</div>

    <script>
        const algoNames = {
            'threshold': 'å›ºå®šé˜ˆå€¼åˆ†å‰²', 'otsu': 'Otsuè‡ªé€‚åº”é˜ˆå€¼', 'kmeans': 'K-meansèšç±»åˆ†å‰²', 'watershed': 'åˆ†æ°´å²­åˆ†å‰²',
            'histogram_eq': 'ç›´æ–¹å›¾å‡è¡¡åŒ–', 'clahe': 'CLAHEè‡ªé€‚åº”å‡è¡¡', 'gamma': 'ä¼½é©¬æ ¡æ­£', 'sharpen': 'é”åŒ–å¢å¼º', 'wiener': 'ç»´çº³æ»¤æ³¢å¤åŸ',
            'edge_multi': 'å¤šç®—å­è¾¹ç¼˜æ£€æµ‹', 'canny': 'Cannyè¾¹ç¼˜æ£€æµ‹',
            'denoise_multi': 'å¤šæ–¹æ³•å»å™ªå¯¹æ¯”', 'gaussian_denoise': 'é«˜æ–¯æ»¤æ³¢å»å™ª', 'median_denoise': 'ä¸­å€¼æ»¤æ³¢å»å™ª',
            'jpeg': 'JPEGå‹ç¼©åˆ†æ', 'dct': 'DCTå˜æ¢å‹ç¼©'
        };

        const keyNames = {
            'method': 'å¤„ç†æ–¹æ³•', 'threshold': 'é˜ˆå€¼', 'optimal_threshold': 'æœ€ä¼˜é˜ˆå€¼',
            'foreground_ratio': 'å‰æ™¯æ¯”ä¾‹(%)', 'contours': 'è½®å»“æ•°', 'k': 'Kå€¼',
            'regions': 'åŒºåŸŸæ•°', 'clip_limit': 'å¯¹æ¯”åº¦é™åˆ¶', 'tile_size': 'åˆ†å—å¤§å°',
            'gamma': 'ä¼½é©¬å€¼', 'strength': 'å¼ºåº¦', 'kernel_size': 'æ ¸å¤§å°',
            'edge_pixels': 'è¾¹ç¼˜åƒç´ æ•°', 'edge_ratio': 'è¾¹ç¼˜æ¯”ä¾‹(%)',
            'best': 'æœ€ä½³æ–¹æ³•', 'best_psnr': 'æœ€ä½³PSNR', 'original_kb': 'åŸå§‹å¤§å°(KB)',
            'block_size': 'å—å¤§å°', 'original_mean': 'åŸå§‹å‡å€¼', 'enhanced_mean': 'å¢å¼ºåå‡å€¼'
        };

        async function loadResults() {
            const urlParams = new URLSearchParams(window.location.search);
            const resultId = urlParams.get('id');
            
            if (!resultId) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
                return;
            }
            
            try {
                const response = await fetch('/get_result/' + resultId);
                const data = await response.json();
                
                if (data.error) {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('error').style.display = 'block';
                    return;
                }
                
                renderResults(data);
            } catch (err) {
                document.getElementById('loading').style.display = 'none';
                document.getElementById('error').style.display = 'block';
            }
        }

        function renderResults(data) {
            const content = document.getElementById('content');
            let html = '';
            
            // æ‘˜è¦
            html += '<div class="summary">';
            html += '<h2>ğŸ“‹ å¤„ç†ç»“æœæ‘˜è¦</h2>';
            html += '<div class="summary-info">';
            html += '<span>å¤„ç†åŠŸèƒ½æ•°: <strong>' + data.results.length + '</strong></span>';
            html += '<span>æ€»è€—æ—¶: <strong>' + data.total_time + ' ç§’</strong></span>';
            html += '<span>ç”Ÿæˆæ—¶é—´: <strong>' + new Date().toLocaleString('zh-CN') + '</strong></span>';
            html += '</div></div>';
            
            // æ¯ä¸ªç»“æœ
            data.results.forEach((result, index) => {
                const m = result.metrics;
                html += '<div class="result-card">';
                html += '<div class="result-header">';
                html += '<span>' + (index + 1) + '. ' + (algoNames[result.algorithm] || result.algorithm) + '</span>';
                html += '<span class="time">è€—æ—¶: ' + result.process_time + 's</span>';
                html += '</div>';
                html += '<div class="result-body">';
                
                // å›¾åƒå¯¹æ¯”
                html += '<div class="images-row">';
                html += '<div class="image-box"><h4>åŸå§‹å›¾åƒ</h4><img src="' + result.original + '"></div>';
                html += '<div class="image-box"><h4>å¤„ç†ç»“æœ</h4><img src="' + result.result + '"></div>';
                html += '</div>';
                
                // æŒ‡æ ‡
                html += '<div class="metrics-row">';
                html += '<div class="metric ' + (m.mse < 100 ? '' : 'warn') + '"><div class="label">MSE</div><div class="value">' + m.mse + '</div></div>';
                html += '<div class="metric ' + (m.psnr === "INF" || m.psnr > 30 ? '' : 'warn') + '"><div class="label">PSNR</div><div class="value">' + m.psnr + '</div><div class="unit">dB</div></div>';
                html += '<div class="metric ' + (m.ssim > 0.9 ? '' : 'warn') + '"><div class="label">SSIM</div><div class="value">' + m.ssim + '</div></div>';
                html += '<div class="metric"><div class="label">è€—æ—¶</div><div class="value">' + result.process_time + '</div><div class="unit">ç§’</div></div>';
                html += '</div>';
                
                // åˆ†æå›¾è¡¨
                html += '<div class="charts-section">';
                html += '<h4>ğŸ“ˆ ç®—æ³•åˆ†æå›¾</h4>';
                html += '<div class="chart-box"><img src="' + result.analysis_chart + '"></div>';
                html += '<h4>ğŸ“Š ç›´æ–¹å›¾åˆ†æ</h4>';
                html += '<div class="chart-box"><img src="' + result.histogram_chart + '"></div>';
                html += '<h4>ğŸŒŠ é¢‘åŸŸåˆ†æ</h4>';
                html += '<div class="chart-box"><img src="' + result.frequency_chart + '"></div>';
                html += '</div>';
                
                // ç»Ÿè®¡è¡¨æ ¼
                html += '<h4>âš™ï¸ å‚æ•°ç»Ÿè®¡</h4>';
                html += '<table class="stats-table"><tbody>';
                for (const [key, value] of Object.entries(result.stats)) {
                    const displayValue = typeof value === 'object' ? JSON.stringify(value) : value;
                    html += '<tr><th>' + (keyNames[key] || key) + '</th><td>' + displayValue + '</td></tr>';
                }
                html += '</tbody></table>';
                
                html += '</div></div>';
            });
            
            content.innerHTML = html;
            document.getElementById('loading').style.display = 'none';
            content.style.display = 'block';
        }

        loadResults();
    </script>
</body>
</html>
